<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Delivery Tracking - Food Delivery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web@2.0.3"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        .pulse-marker { animation: pulse 2s ease-in-out infinite; }
        
        #map { 
            height: 500px; 
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .tracking-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">üìç Live Delivery Tracking</h1>
                    <p class="text-gray-600">Real-time GPS tracking with enhanced precision</p>
                </div>
                <div class="text-right">
                    <div id="trackingStatus" class="tracking-badge bg-gray-100 text-gray-600">
                        <i class="ph-circle"></i>
                        <span>Not Tracking</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left: Controls -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Delivery Info -->
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">üì¶ Delivery Info</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Product ID</label>
                            <input type="text" id="productId" placeholder="Enter product ID" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Order ID</label>
                            <input type="text" id="orderId" placeholder="Enter order ID" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Driver Name</label>
                            <input type="text" id="driverName" placeholder="Enter driver name" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Customer Phone</label>
                            <input type="tel" id="customerPhone" placeholder="+91 XXXXXXXXXX" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- GPS Controls -->
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">üõ∞Ô∏è GPS Controls</h2>
                    
                    <div class="space-y-3">
                        <button onclick="getCurrentLocation()" 
                            class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg transition flex items-center justify-center space-x-2">
                            <i class="ph-crosshair text-xl"></i>
                            <span>Get Current Location</span>
                        </button>

                        <button onclick="startLiveTracking()" id="startBtn"
                            class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg transition flex items-center justify-center space-x-2">
                            <i class="ph-play text-xl"></i>
                            <span>Start Live Tracking</span>
                        </button>

                        <button onclick="stopLiveTracking()" id="stopBtn" disabled
                            class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg transition flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="ph-stop text-xl"></i>
                            <span>Stop Tracking</span>
                        </button>

                        <button onclick="updateBlockchain()" id="updateBtn" disabled
                            class="w-full bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 px-4 rounded-lg transition flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="ph-upload text-xl"></i>
                            <span>Update to Blockchain</span>
                        </button>
                    </div>

                    <!-- GPS Settings -->
                    <div class="mt-4 bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-700 mb-3 text-sm">‚öôÔ∏è GPS Settings</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Update Interval (seconds)</label>
                                <input type="number" id="updateInterval" value="30" min="10" max="300" 
                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Accuracy Threshold (meters)</label>
                                <input type="number" id="accuracyThreshold" value="50" min="10" max="200" 
                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Current Location Info -->
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">üìç Current Location</h2>
                    <div id="locationInfo" class="text-sm text-gray-500 text-center py-4">
                        No location data yet
                    </div>
                </div>
            </div>

            <!-- Right: Map & Tracking -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Map -->
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">üó∫Ô∏è Live Map</h2>
                    <div id="map"></div>
                </div>

                <!-- Tracking History -->
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">üìä Tracking History</h2>
                        <button onclick="clearHistory()" class="text-sm text-red-600 hover:text-red-700">
                            Clear History
                        </button>
                    </div>
                    <div id="trackingHistory" class="space-y-2 max-h-96 overflow-y-auto">
                        <p class="text-gray-400 text-sm text-center py-4">No tracking data yet</p>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">üìà Statistics</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600" id="totalUpdates">0</div>
                            <div class="text-xs text-gray-600">Total Updates</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600" id="avgAccuracy">N/A</div>
                            <div class="text-xs text-gray-600">Avg Accuracy</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-600" id="totalDistance">0 km</div>
                            <div class="text-xs text-gray-600">Distance Traveled</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-orange-600" id="trackingTime">0m</div>
                            <div class="text-xs text-gray-600">Tracking Time</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced GPS Library -->
    <script src="./enhanced-gps.js"></script>

    <script>
        // Initialize GPS and Map
        const gps = new EnhancedGPS();
        let map, marker, route = [];
        let isTracking = false;
        let trackingStartTime = null;
        let lastLocation = null;
        let totalDistance = 0;
        let trackingHistory = [];
        let updateIntervalId = null;

        // Initialize Map
        function initMap() {
            map = L.map('map').setView([28.6139, 77.2090], 13); // Delhi default
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            console.log('‚úÖ Map initialized');
        }

        // Get Current Location (one-time)
        async function getCurrentLocation() {
            try {
                showNotification('Getting your location...', 'info');
                
                const location = await gps.getPreciseLocation({
                    enableWatch: false,
                    accuracyThreshold: parseInt(document.getElementById('accuracyThreshold').value),
                    timeout: 15000,
                    getAddress: true,
                    showProgress: true
                });

                displayLocation(location);
                addToHistory(location, 'Single Update');
                updateMap(location);
                
                document.getElementById('updateBtn').disabled = false;
                
                const accuracyInfo = gps.getAccuracyLevel(location.coordinates.accuracy);
                showNotification(`${accuracyInfo.icon} Location acquired (¬±${location.coordinates.accuracy}m)`, 'success');
                
            } catch (error) {
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        // Start Live Tracking
        async function startLiveTracking() {
            if (isTracking) return;

            const productId = document.getElementById('productId').value;
            const orderId = document.getElementById('orderId').value;
            const driverName = document.getElementById('driverName').value;

            if (!productId || !orderId || !driverName) {
                showNotification('Please fill in Product ID, Order ID, and Driver Name', 'error');
                return;
            }

            isTracking = true;
            trackingStartTime = Date.now();
            route = [];
            totalDistance = 0;

            // Update UI
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            updateTrackingStatus('Tracking', 'bg-green-100 text-green-600', 'ph-circle-fill');

            showNotification('üöÄ Started live tracking', 'success');

            const accuracyThreshold = parseInt(document.getElementById('accuracyThreshold').value);
            const updateInterval = parseInt(document.getElementById('updateInterval').value) * 1000;

            // Start continuous GPS tracking
            gps.startContinuousTracking((location, error) => {
                if (error) {
                    console.error('Tracking error:', error);
                    addToHistory(null, 'Error', error.message);
                } else {
                    handleLocationUpdate(location);
                }
            }, accuracyThreshold);

            // Auto-update to blockchain at intervals
            updateIntervalId = setInterval(async () => {
                if (lastLocation && isTracking) {
                    await updateBlockchain(true);
                }
            }, updateInterval);

            // Update tracking time
            setInterval(() => {
                if (isTracking) {
                    const elapsed = Math.floor((Date.now() - trackingStartTime) / 1000 / 60);
                    document.getElementById('trackingTime').textContent = `${elapsed}m`;
                }
            }, 1000);
        }

        // Stop Live Tracking
        function stopLiveTracking() {
            if (!isTracking) return;

            isTracking = false;
            gps.stopTracking();

            if (updateIntervalId) {
                clearInterval(updateIntervalId);
                updateIntervalId = null;
            }

            // Update UI
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            updateTrackingStatus('Stopped', 'bg-gray-100 text-gray-600', 'ph-circle');

            showNotification('‚èπÔ∏è Stopped tracking', 'info');
        }

        // Handle Location Update
        function handleLocationUpdate(location) {
            lastLocation = location;
            
            displayLocation(location);
            updateMap(location);
            addToHistory(location, 'Live Update');
            
            // Calculate distance
            if (route.length > 0) {
                const lastPoint = route[route.length - 1];
                const distance = gps.calculateDistance(
                    lastPoint.lat, lastPoint.lng,
                    location.coordinates.latitude, location.coordinates.longitude
                );
                totalDistance += distance;
                document.getElementById('totalDistance').textContent = (totalDistance / 1000).toFixed(2) + ' km';
            }

            // Add to route
            route.push({
                lat: location.coordinates.latitude,
                lng: location.coordinates.longitude,
                timestamp: location.timestamp
            });

            // Update statistics
            updateStatistics();
        }

        // Display Location
        function displayLocation(location) {
            const accuracyInfo = gps.getAccuracyLevel(location.coordinates.accuracy);
            const timestamp = new Date(location.timestamp).toLocaleTimeString();

            let html = `
                <div class="space-y-3 text-left">
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-500">Last Update: ${timestamp}</span>
                        <span class="text-xs px-2 py-1 rounded-full" style="background-color: ${accuracyInfo.color}20; color: ${accuracyInfo.color};">
                            ${accuracyInfo.icon} ${accuracyInfo.level}
                        </span>
                    </div>
                    
                    <div class="bg-gray-50 rounded p-2 text-xs">
                        <div class="font-mono"><strong>Lat:</strong> ${location.coordinates.latitude}¬∞</div>
                        <div class="font-mono"><strong>Lng:</strong> ${location.coordinates.longitude}¬∞</div>
                        <div><strong>Accuracy:</strong> ¬±${location.coordinates.accuracy}m</div>
                    </div>
            `;

            if (location.address && !location.address.error) {
                html += `
                    <div class="text-xs">
                        <strong>Address:</strong><br>
                        ${location.address.formattedAddress}
                    </div>
                `;
            }

            html += `</div>`;
            document.getElementById('locationInfo').innerHTML = html;
        }

        // Update Map
        function updateMap(location) {
            const lat = location.coordinates.latitude;
            const lng = location.coordinates.longitude;

            // Update or create marker
            if (marker) {
                marker.setLatLng([lat, lng]);
            } else {
                marker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        html: '<div class="pulse-marker" style="background: #3b82f6; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"></div>',
                        className: '',
                        iconSize: [20, 20]
                    })
                }).addTo(map);
            }

            // Draw route
            if (route.length > 1) {
                const routeCoords = route.map(p => [p.lat, p.lng]);
                L.polyline(routeCoords, {
                    color: '#3b82f6',
                    weight: 4,
                    opacity: 0.7
                }).addTo(map);
            }

            // Center map
            map.setView([lat, lng], 16);
        }

        // Add to History
        function addToHistory(location, type, errorMsg = null) {
            const historyDiv = document.getElementById('trackingHistory');
            
            if (historyDiv.querySelector('.text-gray-400')) {
                historyDiv.innerHTML = '';
            }

            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            
            if (errorMsg) {
                entry.className = 'bg-red-50 border border-red-200 rounded-lg p-3 text-sm';
                entry.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-semibold text-red-800">‚ùå ${type}</div>
                            <div class="text-red-600 text-xs mt-1">${errorMsg}</div>
                        </div>
                        <span class="text-xs text-red-500">${timestamp}</span>
                    </div>
                `;
            } else {
                const accuracyInfo = gps.getAccuracyLevel(location.coordinates.accuracy);
                entry.className = 'bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm';
                entry.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="font-semibold text-blue-800">${accuracyInfo.icon} ${type}</div>
                            <div class="text-xs text-gray-600 mt-1">
                                ${location.coordinates.latitude.toFixed(6)}¬∞, ${location.coordinates.longitude.toFixed(6)}¬∞
                                <span class="ml-2">(¬±${location.coordinates.accuracy}m)</span>
                            </div>
                        </div>
                        <span class="text-xs text-blue-500">${timestamp}</span>
                    </div>
                `;
            }

            historyDiv.insertBefore(entry, historyDiv.firstChild);
            trackingHistory.push({ location, type, timestamp, errorMsg });

            // Keep only last 100 entries
            while (historyDiv.children.length > 100) {
                historyDiv.removeChild(historyDiv.lastChild);
            }
        }

        // Update Blockchain
        async function updateBlockchain(auto = false) {
            if (!lastLocation) {
                showNotification('No location data to update', 'error');
                return;
            }

            try {
                const productId = document.getElementById('productId').value;
                const orderId = document.getElementById('orderId').value;
                const driverName = document.getElementById('driverName').value;

                showNotification('üì§ Updating blockchain...', 'info');

                // Here you would call your blockchain update function
                // For now, just simulate
                await new Promise(resolve => setTimeout(resolve, 2000));

                const msg = auto ? 'Auto-updated to blockchain' : 'Manually updated to blockchain';
                showNotification(`‚úÖ ${msg}`, 'success');
                addToHistory(lastLocation, 'Blockchain Update');

            } catch (error) {
                showNotification(`Blockchain update failed: ${error.message}`, 'error');
            }
        }

        // Update Statistics
        function updateStatistics() {
            document.getElementById('totalUpdates').textContent = trackingHistory.length;

            const accuracies = trackingHistory
                .filter(h => h.location)
                .map(h => h.location.coordinates.accuracy);
            
            if (accuracies.length > 0) {
                const avgAccuracy = accuracies.reduce((a, b) => a + b, 0) / accuracies.length;
                document.getElementById('avgAccuracy').textContent = Math.round(avgAccuracy) + 'm';
            }
        }

        // Update Tracking Status
        function updateTrackingStatus(status, className, icon) {
            const statusDiv = document.getElementById('trackingStatus');
            statusDiv.className = `tracking-badge ${className}`;
            statusDiv.innerHTML = `<i class="${icon}"></i><span>${status}</span>`;
        }

        // Show Notification
        function showNotification(message, type) {
            // Simple console log for now
            const emoji = {
                success: '‚úÖ',
                error: '‚ùå',
                info: '‚ÑπÔ∏è',
                warning: '‚ö†Ô∏è'
            };
            console.log(`${emoji[type] || '‚ÑπÔ∏è'} ${message}`);
            
            // You can implement a toast notification here
        }

        // Clear History
        function clearHistory() {
            document.getElementById('trackingHistory').innerHTML = '<p class="text-gray-400 text-sm text-center py-4">No tracking data yet</p>';
            trackingHistory = [];
            updateStatistics();
        }

        // Initialize on load
        window.addEventListener('load', () => {
            initMap();
            console.log('üöÄ Live Delivery Tracking Ready');
        });
    </script>
</body>
</html>
