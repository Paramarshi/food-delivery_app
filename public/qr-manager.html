<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product QR Code Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        .product-card {
            transition: all 0.3s ease;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-blue-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">
                <i class="ph-fill ph-qr-code text-purple-600"></i>
                Product QR Code Manager
            </h1>
            <p class="text-gray-600">Search products and generate unique QR codes for blockchain tracking</p>
        </div>

        <!-- Search & Filter -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Search Input -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Search Products</label>
                    <div class="relative">
                        <i class="ph-bold ph-magnifying-glass absolute left-3 top-3 text-gray-400"></i>
                        <input 
                            type="text" 
                            id="searchInput"
                            placeholder="Search by name, ID, or category..."
                            class="w-full pl-10 pr-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                        />
                    </div>
                </div>

                <!-- Category Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                    <select id="categoryFilter" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none">
                        <option value="">All Categories</option>
                        <option value="Fruits">Fruits</option>
                        <option value="Vegetables">Vegetables</option>
                        <option value="Dairy">Dairy</option>
                        <option value="Bakery">Bakery</option>
                        <option value="Beauty & wellness">Beauty & Wellness</option>
                        <option value="Pharmacy">Pharmacy</option>
                    </select>
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                <div class="bg-purple-50 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-purple-600" id="totalProducts">0</div>
                    <div class="text-sm text-gray-600">Total Products</div>
                </div>
                <div class="bg-blue-50 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-blue-600" id="filteredProducts">0</div>
                    <div class="text-sm text-gray-600">Filtered Results</div>
                </div>
                <div class="bg-green-50 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-green-600" id="qrGenerated">0</div>
                    <div class="text-sm text-gray-600">QR Codes Generated</div>
                </div>
                <div class="bg-orange-50 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-orange-600" id="categories">0</div>
                    <div class="text-sm text-gray-600">Categories</div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
            <div class="flex flex-wrap gap-4">
                <button onclick="generateAllQRCodes()" class="flex items-center gap-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all">
                    <i class="ph-bold ph-qr-code"></i>
                    Generate All QR Codes
                </button>
                <button onclick="downloadAllAsZip()" class="flex items-center gap-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all">
                    <i class="ph-bold ph-download-simple"></i>
                    Download All (ZIP)
                </button>
                <button onclick="exportToCSV()" class="flex items-center gap-2 bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all">
                    <i class="ph-bold ph-file-csv"></i>
                    Export to CSV
                </button>
                <button onclick="printAllLabels()" class="flex items-center gap-2 bg-gradient-to-r from-orange-500 to-orange-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all">
                    <i class="ph-bold ph-printer"></i>
                    Print All Labels
                </button>
            </div>
        </div>

        <!-- Products Grid -->
        <div id="productsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Products will be inserted here -->
        </div>

        <!-- No Results -->
        <div id="noResults" class="hidden text-center py-12">
            <i class="ph-bold ph-magnifying-glass text-6xl text-gray-300 mb-4"></i>
            <p class="text-xl text-gray-500">No products found</p>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800" id="modalTitle">Product QR Code</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="ph-bold ph-x text-2xl"></i>
                </button>
            </div>
            
            <div class="text-center">
                <!-- Product Info -->
                <div class="mb-4">
                    <img id="modalProductImage" src="" alt="" class="w-32 h-32 object-cover rounded-lg mx-auto mb-4">
                    <p class="font-bold text-lg" id="modalProductName"></p>
                    <p class="text-sm text-gray-600" id="modalProductId"></p>
                </div>

                <!-- QR Code -->
                <div class="bg-white p-6 rounded-lg inline-block mb-4 border-2 border-gray-200">
                    <canvas id="qrCanvas"></canvas>
                </div>
                
                <!-- Tracking URL -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-600 mb-2">Tracking URL:</p>
                    <p class="text-xs break-all font-mono" id="trackingUrl"></p>
                </div>
                
                <!-- Actions -->
                <div class="space-y-2">
                    <button onclick="downloadQR()" class="w-full px-6 py-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl hover:shadow-lg transition-all">
                        <i class="ph-bold ph-download-simple"></i> Download QR Code
                    </button>
                    <button onclick="printLabel()" class="w-full px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl hover:shadow-lg transition-all">
                        <i class="ph-bold ph-printer"></i> Print Label
                    </button>
                    <button onclick="copyTrackingUrl()" class="w-full px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl hover:shadow-lg transition-all">
                        <i class="ph-bold ph-copy"></i> Copy URL
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="./supplychain-web3.js"></script>
    <script>
        // Import products from main website
        const products = [
            // Fruits
            { id: 1, name: 'Fresh Apples', image: 'https://cdn.zeptonow.com/production/tr:w-403,ar-1024-1024,pr-true,f-auto,q-80/cms/product_variant/8758d987-e101-46d3-9c9b-f2babc5d6389.jpeg', category: 'Fruits', variants: [{unit: '500 g', price: 75}, {unit: '1 kg', price: 150}] },
            { id: 2, name: 'Ripe Bananas', image: 'https://cdn.zeptonow.com/production/tr:w-403,ar-3000-3000,pr-true,f-auto,q-80/cms/product_variant/2ce10ffc-348b-4f20-a0c4-6f004c162c90.jpeg', category: 'Fruits', variants: [{unit: '6 pcs', price: 30}, {unit: '1 dozen', price: 50}] },
            { id: 13, name: 'Mangoes', image: 'https://www.bbassets.com/media/uploads/p/m/10000343_9-fresho-mango-neelam.jpg?tr=w-154,q-80', category: 'Fruits', variants: [{unit: '500 g', price: 200}, {unit: '1 kg', price: 380}] },
            { id: 14, name: 'Pineapple', image: 'https://cdn.zeptonow.com/production/tr:w-403,ar-1024-1536,pr-true,f-auto,q-80/cms/product_variant/088cb923-8d1a-431f-98ea-2f01259b3545.png', category: 'Fruits', variants: [{unit: '1 piece', price: 45}, {unit: '1 kg', price: 35}] },
            
            // Vegetables
            { id: 24, name: 'Tomatoes', image: 'https://cdn.zeptonow.com/production/tr:w-403,ar-1024-1024,pr-true,f-auto,q-80/cms/product_variant/04a3037a-04a3-47f3-9db4-23ae268177aa.jpeg', category: 'Vegetables', variants: [{unit: '250 g', price: 24}, {unit: '500 g', price: 42}] },
            { id: 25, name: 'Onion (Pyaz)', image: 'https://cdn.zeptonow.com/production/tr:w-403,ar-3000-3000,pr-true,f-auto,q-80/cms/product_variant/49dcc487-39ac-45a3-8ed6-654ff0afa825.jpeg', category: 'Vegetables', variants: [{unit: '500 g', price: 15}, {unit: '1 kg', price: 31}] },
            
            // Dairy
            { id: 51, name: 'Organic Milk', image: 'https://images.unsplash.com/photo-1559598467-f8b76c8155d0?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=400', category: 'Dairy', variants: [{unit: '500 ml', price: 25}, {unit: '1 litre', price: 48}] },
            { id: 52, name: 'Eggs', image: 'https://cdn.zeptonow.com/production/tr:w-1280,ar-1200-1200,pr-true,f-auto,q-80/cms/product_variant/35241f67-e64e-4f15-8c9e-175186993049.jpeg', category: 'Dairy', variants: [{unit: '6 pack', price: 40}, {unit: '12 pack', price: 70}] },
        ];

        // Generate product IDs
        function generateProductCode(name, id) {
            const prefix = name.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 10);
            const timestamp = Date.now().toString(36).toUpperCase();
            const productNum = id.toString().padStart(4, '0');
            return `${prefix}_${productNum}_${timestamp.substring(0, 6)}`;
        }

        // Add unique IDs to products
        products.forEach(product => {
            product.uniqueId = generateProductCode(product.name, product.id);
            product.trackingUrl = `${window.location.origin}/public/profile.html?track=${product.uniqueId}`;
        });

        let filteredProducts = [...products];
        let qrGeneratedCount = 0;
        let currentProduct = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            renderProducts();
            updateStats();
            setupFilters();
        });

        function setupFilters() {
            const searchInput = document.getElementById('searchInput');
            const categoryFilter = document.getElementById('categoryFilter');

            searchInput.addEventListener('input', filterProducts);
            categoryFilter.addEventListener('change', filterProducts);
        }

        function filterProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;

            filteredProducts = products.filter(product => {
                const matchesSearch = !searchTerm || 
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.uniqueId.toLowerCase().includes(searchTerm) ||
                    product.category.toLowerCase().includes(searchTerm);
                
                const matchesCategory = !category || product.category === category;

                return matchesSearch && matchesCategory;
            });

            renderProducts();
            updateStats();
        }

        function renderProducts() {
            const container = document.getElementById('productsContainer');
            const noResults = document.getElementById('noResults');

            if (filteredProducts.length === 0) {
                container.innerHTML = '';
                noResults.classList.remove('hidden');
                return;
            }

            noResults.classList.add('hidden');
            container.innerHTML = filteredProducts.map(product => `
                <div class="product-card bg-white rounded-xl shadow-lg overflow-hidden">
                    <img src="${product.image}" alt="${product.name}" class="w-full h-48 object-cover">
                    <div class="p-4">
                        <div class="mb-2">
                            <span class="text-xs px-2 py-1 bg-purple-100 text-purple-600 rounded-full">${product.category}</span>
                        </div>
                        <h3 class="font-bold text-lg mb-2">${product.name}</h3>
                        <div class="mb-3">
                            <p class="text-xs text-gray-500">Product ID:</p>
                            <p class="text-sm font-mono font-bold text-gray-700 break-all">${product.uniqueId}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="showQRModal(${product.id})" class="flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all text-sm">
                                <i class="ph-bold ph-qr-code"></i> View QR
                            </button>
                            <button onclick="quickDownload(${product.id})" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all">
                                <i class="ph-bold ph-download-simple"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateStats() {
            document.getElementById('totalProducts').textContent = products.length;
            document.getElementById('filteredProducts').textContent = filteredProducts.length;
            document.getElementById('qrGenerated').textContent = qrGeneratedCount;
            const uniqueCategories = [...new Set(products.map(p => p.category))];
            document.getElementById('categories').textContent = uniqueCategories.length;
        }

        function showQRModal(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            currentProduct = product;
            
            document.getElementById('modalProductImage').src = product.image;
            document.getElementById('modalProductName').textContent = product.name;
            document.getElementById('modalProductId').textContent = product.uniqueId;
            document.getElementById('trackingUrl').textContent = product.trackingUrl;
            document.getElementById('modalTitle').textContent = `${product.name} - QR Code`;

            // Generate QR Code
            const canvas = document.getElementById('qrCanvas');
            QRCode.toCanvas(canvas, product.trackingUrl, {
                width: 250,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            }, (error) => {
                if (error) console.error(error);
            });

            document.getElementById('qrModal').classList.remove('hidden');
            document.getElementById('qrModal').classList.add('flex');
            qrGeneratedCount++;
            updateStats();
        }

        function closeModal() {
            document.getElementById('qrModal').classList.add('hidden');
            document.getElementById('qrModal').classList.remove('flex');
        }

        function downloadQR() {
            if (!currentProduct) return;
            
            const canvas = document.getElementById('qrCanvas');
            const url = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = `${currentProduct.uniqueId}_QR.png`;
            link.href = url;
            link.click();
            
            showNotification('QR code downloaded successfully!', 'success');
        }

        function printLabel() {
            if (!currentProduct) return;
            
            const canvas = document.getElementById('qrCanvas');
            const qrImage = canvas.toDataURL('image/png');
            
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Print Label - ${currentProduct.name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .label { border: 2px solid #000; padding: 20px; max-width: 400px; text-align: center; }
                        .label h2 { margin: 0 0 10px 0; }
                        .label .product-id { font-family: 'Courier New', monospace; background: #f0f0f0; padding: 10px; margin: 10px 0; font-size: 14px; }
                        .label img { margin: 20px 0; }
                        @media print {
                            body { margin: 0; padding: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="label">
                        <h2>${currentProduct.name}</h2>
                        <div class="product-id">${currentProduct.uniqueId}</div>
                        <img src="${qrImage}" alt="QR Code" width="200" />
                        <p><strong>Category:</strong> ${currentProduct.category}</p>
                        <p style="font-size: 12px; color: #666;">ðŸ“± Scan QR code to track product journey</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function copyTrackingUrl() {
            if (!currentProduct) return;
            
            navigator.clipboard.writeText(currentProduct.trackingUrl).then(() => {
                showNotification('Tracking URL copied to clipboard!', 'success');
            });
        }

        function quickDownload(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const canvas = document.createElement('canvas');
            QRCode.toCanvas(canvas, product.trackingUrl, {
                width: 400,
                margin: 2
            }, (error) => {
                if (error) {
                    console.error(error);
                    return;
                }
                
                const url = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `${product.uniqueId}_QR.png`;
                link.href = url;
                link.click();
                
                qrGeneratedCount++;
                updateStats();
                showNotification(`QR code for ${product.name} downloaded!`, 'success');
            });
        }

        function generateAllQRCodes() {
            if (!confirm(`Generate QR codes for all ${filteredProducts.length} products?`)) return;
            
            showNotification('Generating QR codes...', 'info');
            
            filteredProducts.forEach((product, index) => {
                setTimeout(() => {
                    quickDownload(product.id);
                }, index * 100);
            });
        }

        function exportToCSV() {
            const csv = ['Product ID,Name,Category,Tracking URL\n'];
            filteredProducts.forEach(product => {
                csv.push(`${product.uniqueId},"${product.name}",${product.category},${product.trackingUrl}\n`);
            });
            
            const blob = new Blob(csv, { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = 'products_qr_codes.csv';
            link.href = url;
            link.click();
            
            showNotification('CSV file downloaded!', 'success');
        }

        function showNotification(message, type = 'info') {
            // Simple notification
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                'bg-blue-500'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>
