<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöö Real-Time Delivery Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web@2.0.3"></script>
    <script src="./ethers.min.js"></script>
    <style>
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .tracking-dot {
            width: 12px;
            height: 12px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }
        .location-card {
            transition: all 0.3s ease;
        }
        .location-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        #map-container {
            height: 400px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        .accuracy-indicator {
            position: absolute;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid #10b981;
            animation: pulse 2s infinite;
        }
        .gps-signal {
            display: inline-flex;
            gap: 2px;
            align-items: flex-end;
        }
        .gps-bar {
            width: 3px;
            background: #10b981;
            transition: all 0.3s;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <div class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i class="ph-truck text-4xl text-indigo-600"></i>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Real-Time Delivery Tracker</h1>
                        <p class="text-sm text-gray-600">Precise GPS Location Tracking</p>
                    </div>
                </div>
                <div id="gps-status" class="flex items-center gap-2 px-4 py-2 bg-gray-100 rounded-lg">
                    <i class="ph-circle-dashed text-gray-400 animate-spin"></i>
                    <span class="text-sm text-gray-600">Initializing GPS...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <button onclick="getQuickLocation()" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-4 rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-3">
                <i class="ph-navigation-arrow text-2xl"></i>
                <span class="font-semibold">Quick GPS Fix</span>
            </button>
            <button onclick="getPreciseLocation()" class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-4 rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-3">
                <i class="ph-crosshair-simple text-2xl"></i>
                <span class="font-semibold">High Precision GPS</span>
            </button>
            <button onclick="startContinuousTracking()" class="bg-gradient-to-r from-purple-500 to-pink-600 text-white p-4 rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-3">
                <i class="ph-broadcast text-2xl"></i>
                <span class="font-semibold">Continuous Tracking</span>
            </button>
        </div>

        <!-- Current Location Display -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                    <i class="ph-map-pin text-indigo-600"></i>
                    Current Location
                </h2>
                <div id="accuracy-badge" class="px-4 py-2 bg-gray-100 rounded-lg text-sm font-semibold text-gray-600">
                    Waiting for GPS...
                </div>
            </div>

            <!-- Map Visualization -->
            <div id="map-container" class="mb-4 flex items-center justify-center">
                <div class="text-white text-center">
                    <i class="ph-map-pin-line text-6xl mb-3 opacity-80"></i>
                    <p class="text-lg font-semibold">Enable GPS to see your location</p>
                    <p class="text-sm opacity-80">Click any button above to start tracking</p>
                </div>
            </div>

            <!-- Location Details Grid -->
            <div id="location-details" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="location-card bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl">
                    <div class="flex items-center gap-3 mb-2">
                        <i class="ph-buildings text-2xl text-blue-600"></i>
                        <span class="text-sm font-semibold text-gray-600">Address</span>
                    </div>
                    <p id="address-display" class="text-gray-800 font-medium">Not detected yet</p>
                </div>
                <div class="location-card bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-xl">
                    <div class="flex items-center gap-3 mb-2">
                        <i class="ph-map-pin-line text-2xl text-green-600"></i>
                        <span class="text-sm font-semibold text-gray-600">Coordinates</span>
                    </div>
                    <p id="coords-display" class="text-gray-800 font-medium font-mono">---.----, ---.----</p>
                </div>
                <div class="location-card bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-xl">
                    <div class="flex items-center gap-3 mb-2">
                        <i class="ph-crosshair text-2xl text-purple-600"></i>
                        <span class="text-sm font-semibold text-gray-600">Accuracy</span>
                    </div>
                    <p id="accuracy-display" class="text-gray-800 font-medium">-- meters</p>
                </div>
                <div class="location-card bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-xl">
                    <div class="flex items-center gap-3 mb-2">
                        <i class="ph-clock text-2xl text-orange-600"></i>
                        <span class="text-sm font-semibold text-gray-600">Last Updated</span>
                    </div>
                    <p id="time-display" class="text-gray-800 font-medium">Never</p>
                </div>
            </div>
        </div>

        <!-- Update Delivery Form -->
        <div class="bg-white rounded-2xl shadow-xl p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-2">
                <i class="ph-package text-indigo-600"></i>
                Update Delivery Location
            </h2>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Product ID</label>
                    <input type="number" id="product-id" placeholder="Enter product ID" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Delivery Stage</label>
                    <select id="delivery-stage" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <option value="4">üè≠ Warehouse</option>
                        <option value="5">üì¶ Distribution Center</option>
                        <option value="6">üè™ Local Store</option>
                        <option value="7">üöö Out for Delivery</option>
                        <option value="8">‚úÖ Delivered</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Delivery Notes</label>
                    <textarea id="delivery-notes" rows="3" placeholder="e.g., Driver: John, Package in good condition" 
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Temperature (¬∞C)</label>
                    <input type="number" id="temperature" placeholder="e.g., 5" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>

                <button onclick="updateDeliveryLocation()" 
                        class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-xl font-semibold text-lg shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-3">
                    <i class="ph-check-circle text-2xl"></i>
                    Update Delivery Location on Blockchain
                </button>
            </div>
        </div>

        <!-- Location History -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mt-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                <i class="ph-clock-clockwise text-indigo-600"></i>
                Location Update History
            </h2>
            <div id="location-history" class="space-y-3">
                <p class="text-gray-500 text-center py-8">No location updates yet</p>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="fixed top-20 right-4 px-6 py-4 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50">
        <p id="notification-text" class="text-white font-semibold"></p>
    </div>

    <script>
        let currentLocation = null;
        let trackingWatchId = null;
        let locationHistory = [];
        let web3Instance = null;

        // Initialize blockchain connection
        async function initBlockchain() {
            try {
                if (typeof ethers === 'undefined') {
                    throw new Error('Ethers.js not loaded');
                }

                const provider = new ethers.JsonRpcProvider('http://127.0.0.1:8545');
                const contractAddress = '0x5FbDB2315678afecb367f032d93F642f64180aa3';
                const contractABI = [
                    "function addCheckpoint(uint256 productId, uint256 stage, string memory locationName, string memory gpsCoordinates, uint256 temperature, string memory notes) external",
                    "function getProduct(uint256 productId) external view returns (string, string, string, address, uint256, bool)"
                ];

                const signer = await provider.getSigner();
                web3Instance = new ethers.Contract(contractAddress, contractABI, signer);

                updateGPSStatus('ready', 'Blockchain Connected');
                console.log('‚úÖ Blockchain initialized');
            } catch (error) {
                console.error('Blockchain init error:', error);
                showNotification('‚ö†Ô∏è Blockchain connection failed. Location tracking will work, but updates won\'t be saved.', 'warning');
            }
        }

        // Quick GPS fix (faster but less accurate)
        function getQuickLocation() {
            if (!navigator.geolocation) {
                showNotification('‚ùå Geolocation not supported', 'error');
                return;
            }

            updateGPSStatus('searching', 'Getting quick GPS fix...');

            const options = {
                enableHighAccuracy: false,  // Faster but less precise
                timeout: 5000,
                maximumAge: 10000  // Can use cached location up to 10s old
            };

            navigator.geolocation.getCurrentPosition(
                position => handleLocationSuccess(position, 'Quick Fix'),
                handleLocationError,
                options
            );
        }

        // High precision GPS (slower but more accurate)
        function getPreciseLocation() {
            if (!navigator.geolocation) {
                showNotification('‚ùå Geolocation not supported', 'error');
                return;
            }

            updateGPSStatus('searching', 'Getting high precision GPS...');

            const options = {
                enableHighAccuracy: true,   // Use GPS for best accuracy
                timeout: 30000,             // Longer timeout for precision
                maximumAge: 0               // Always get fresh location
            };

            navigator.geolocation.getCurrentPosition(
                position => handleLocationSuccess(position, 'High Precision'),
                handleLocationError,
                options
            );
        }

        // Continuous tracking (real-time updates)
        function startContinuousTracking() {
            if (!navigator.geolocation) {
                showNotification('‚ùå Geolocation not supported', 'error');
                return;
            }

            // Stop existing tracking
            if (trackingWatchId !== null) {
                navigator.geolocation.clearWatch(trackingWatchId);
                trackingWatchId = null;
                updateGPSStatus('ready', 'Tracking Stopped');
                showNotification('‚è∏Ô∏è Continuous tracking stopped', 'info');
                return;
            }

            updateGPSStatus('tracking', 'Continuous tracking active');

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            trackingWatchId = navigator.geolocation.watchPosition(
                position => handleLocationSuccess(position, 'Continuous'),
                handleLocationError,
                options
            );

            showNotification('üéØ Continuous tracking started', 'success');
        }

        // Handle successful location acquisition
        async function handleLocationSuccess(position, mode) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            const timestamp = new Date(position.timestamp);

            currentLocation = {
                latitude: lat,
                longitude: lng,
                accuracy: accuracy,
                timestamp: timestamp,
                mode: mode
            };

            // Update UI
            document.getElementById('coords-display').textContent = 
                `${lat.toFixed(6)}¬∞, ${lng.toFixed(6)}¬∞`;
            
            const accuracyColor = accuracy < 50 ? 'text-green-600' : accuracy < 100 ? 'text-yellow-600' : 'text-orange-600';
            document.getElementById('accuracy-display').innerHTML = 
                `<span class="${accuracyColor}">¬±${Math.round(accuracy)}m</span>`;
            
            document.getElementById('time-display').textContent = 
                timestamp.toLocaleTimeString();

            // Update accuracy badge
            const badge = document.getElementById('accuracy-badge');
            if (accuracy < 50) {
                badge.className = 'px-4 py-2 bg-green-100 text-green-800 rounded-lg text-sm font-semibold';
                badge.textContent = 'üéØ High Precision';
            } else if (accuracy < 100) {
                badge.className = 'px-4 py-2 bg-yellow-100 text-yellow-800 rounded-lg text-sm font-semibold';
                badge.textContent = 'üìç Good Accuracy';
            } else {
                badge.className = 'px-4 py-2 bg-orange-100 text-orange-800 rounded-lg text-sm font-semibold';
                badge.textContent = 'üìå Approximate';
            }

            // Get address
            try {
                const address = await reverseGeocode(lat, lng);
                document.getElementById('address-display').textContent = address;
                currentLocation.address = address;
            } catch (error) {
                document.getElementById('address-display').textContent = 'Address lookup failed';
            }

            // Update map visualization
            updateMapVisualization(lat, lng, accuracy);

            // Add to history
            addToHistory(mode, lat, lng, accuracy, timestamp);

            // Update GPS status
            updateGPSStatus('active', `${mode} - ${Math.round(accuracy)}m accuracy`);

            showNotification(`üìç Location acquired (¬±${Math.round(accuracy)}m)`, 'success');
        }

        // Handle location errors
        function handleLocationError(error) {
            updateGPSStatus('error', 'GPS Error');
            
            let message = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = '‚ùå Location permission denied. Please enable location access.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = '‚ùå Location unavailable. Check GPS/WiFi connection.';
                    break;
                case error.TIMEOUT:
                    message = '‚è±Ô∏è Location request timeout. Try Quick GPS Fix.';
                    break;
                default:
                    message = '‚ùå Unknown error getting location.';
            }
            
            showNotification(message, 'error');
        }

        // Reverse geocode coordinates to address
        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(
                    `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`
                );
                const data = await response.json();
                
                const parts = [];
                if (data.locality) parts.push(data.locality);
                if (data.city) parts.push(data.city);
                if (data.principalSubdivision) parts.push(data.principalSubdivision);
                if (data.postcode) parts.push(data.postcode);
                
                return parts.join(', ') || data.localityInfo?.administrative?.[0]?.name || 'Unknown location';
            } catch (error) {
                console.error('Geocoding error:', error);
                return `${lat.toFixed(4)}¬∞, ${lng.toFixed(4)}¬∞`;
            }
        }

        // Update map visualization
        function updateMapVisualization(lat, lng, accuracy) {
            const mapContainer = document.getElementById('map-container');
            mapContainer.innerHTML = `
                <div class="absolute inset-0 flex items-center justify-center">
                    <div class="accuracy-indicator" style="width: ${Math.min(accuracy * 2, 300)}px; height: ${Math.min(accuracy * 2, 300)}px;"></div>
                    <div class="absolute text-white text-center z-10">
                        <i class="ph-map-pin-fill text-6xl drop-shadow-lg"></i>
                        <p class="text-lg font-bold mt-2">Your Location</p>
                        <p class="text-sm opacity-90">${lat.toFixed(6)}¬∞, ${lng.toFixed(6)}¬∞</p>
                        <p class="text-xs opacity-80 mt-1">Accuracy: ¬±${Math.round(accuracy)}m</p>
                    </div>
                </div>
            `;
        }

        // Add location to history
        function addToHistory(mode, lat, lng, accuracy, timestamp) {
            locationHistory.unshift({
                mode, lat, lng, accuracy, timestamp
            });

            if (locationHistory.length > 10) locationHistory.pop();

            const historyContainer = document.getElementById('location-history');
            historyContainer.innerHTML = locationHistory.map((loc, index) => `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                    <div class="flex items-center gap-4">
                        <div class="tracking-dot"></div>
                        <div>
                            <p class="font-semibold text-gray-900">${loc.lat.toFixed(6)}¬∞, ${loc.lng.toFixed(6)}¬∞</p>
                            <p class="text-sm text-gray-600">${loc.mode} mode - ¬±${Math.round(loc.accuracy)}m</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500">${loc.timestamp.toLocaleTimeString()}</p>
                </div>
            `).join('');
        }

        // Update GPS status indicator
        function updateGPSStatus(status, text) {
            const statusDiv = document.getElementById('gps-status');
            let icon, color;

            switch(status) {
                case 'ready':
                    icon = 'ph-check-circle';
                    color = 'text-green-600 bg-green-50';
                    break;
                case 'searching':
                    icon = 'ph-circle-dashed animate-spin';
                    color = 'text-blue-600 bg-blue-50';
                    break;
                case 'tracking':
                    icon = 'ph-broadcast';
                    color = 'text-purple-600 bg-purple-50';
                    break;
                case 'active':
                    icon = 'ph-navigation-arrow';
                    color = 'text-green-600 bg-green-50';
                    break;
                case 'error':
                    icon = 'ph-warning';
                    color = 'text-red-600 bg-red-50';
                    break;
                default:
                    icon = 'ph-circle-dashed';
                    color = 'text-gray-600 bg-gray-50';
            }

            statusDiv.className = `flex items-center gap-2 px-4 py-2 rounded-lg ${color}`;
            statusDiv.innerHTML = `
                <i class="${icon}"></i>
                <span class="text-sm font-semibold">${text}</span>
            `;
        }

        // Update delivery location on blockchain
        async function updateDeliveryLocation() {
            const productId = document.getElementById('product-id').value;
            const stage = document.getElementById('delivery-stage').value;
            const notes = document.getElementById('delivery-notes').value || 'Location updated';
            const temperature = document.getElementById('temperature').value || '0';

            if (!productId) {
                showNotification('‚ùå Please enter a product ID', 'error');
                return;
            }

            if (!currentLocation) {
                showNotification('‚ùå Please get your current location first', 'error');
                return;
            }

            if (!web3Instance) {
                showNotification('‚ùå Blockchain not connected', 'error');
                return;
            }

            try {
                showNotification('üì§ Updating location on blockchain...', 'info');

                const locationName = currentLocation.address || `${currentLocation.latitude.toFixed(4)}¬∞, ${currentLocation.longitude.toFixed(4)}¬∞`;
                const gpsCoords = `${currentLocation.latitude.toFixed(7)}¬∞, ${currentLocation.longitude.toFixed(7)}¬∞ (¬±${Math.round(currentLocation.accuracy)}m)`;

                const tx = await web3Instance.addCheckpoint(
                    productId,
                    stage,
                    locationName,
                    gpsCoords,
                    temperature,
                    notes
                );

                showNotification('‚è≥ Waiting for blockchain confirmation...', 'info');
                await tx.wait();

                showNotification('‚úÖ Delivery location updated successfully!', 'success');

                // Clear form
                document.getElementById('product-id').value = '';
                document.getElementById('delivery-notes').value = '';
                document.getElementById('temperature').value = '';

            } catch (error) {
                console.error('Update error:', error);
                showNotification('‚ùå Failed to update location: ' + error.message, 'error');
            }
        }

        // Show notification
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');

            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };

            notification.className = `fixed top-20 right-4 px-6 py-4 rounded-lg shadow-lg transition-transform duration-300 z-50 ${colors[type]}`;
            notificationText.textContent = message;

            notification.style.transform = 'translateX(0)';

            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
            }, 4000);
        }

        // Initialize on page load
        window.addEventListener('load', async () => {
            await initBlockchain();
            
            // Auto-start with quick GPS fix
            setTimeout(() => {
                getQuickLocation();
            }, 500);
        });
    </script>
</body>
</html>
